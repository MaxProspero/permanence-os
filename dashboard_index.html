<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Permanence OS — Command Center</title>
  <style>
    /* ─── DESIGN SYSTEM ─────────────────────────────────────────── */
    :root {
      --black:     #0A0A0A;
      --dark:      #111111;
      --surface:   #161616;
      --border:    #242424;
      --dim:       #333333;
      --muted:     #666666;
      --text:      #E8E4DC;
      --text-sub:  #8A8680;
      --accent:    #C9B77A;    /* gold — for authority */
      --alert:     #C25B4E;    /* red — for attention */
      --safe:      #5B8C5A;    /* green — for confirmed */
      --info:      #4A7A9B;    /* blue — for information */
      --font:      'Inter', 'SF Pro Display', system-ui, sans-serif;
      --mono:      'JetBrains Mono', 'SF Mono', 'Courier New', monospace;
      --radius:    6px;
      --transition: 150ms ease;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--black);
      color: var(--text);
      font-family: var(--font);
      font-size: 14px;
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ─── LAYOUT ─────────────────────────────────────────────────── */
    .shell {
      display: grid;
      grid-template-columns: 220px 1fr;
      grid-template-rows: 52px 1fr;
      height: 100vh;
    }

    .topbar {
      grid-column: 1 / -1;
      background: var(--dark);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
    }

    .nav {
      background: var(--dark);
      border-right: 1px solid var(--border);
      padding: 24px 0;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .main {
      overflow-y: auto;
      padding: 32px;
      background: var(--black);
    }

    /* ─── TOPBAR ─────────────────────────────────────────────────── */
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-mark {
      width: 22px;
      height: 22px;
      border: 1.5px solid var(--accent);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .brand-mark svg { width: 12px; height: 12px; }

    .brand-name {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text);
    }

    .brand-version {
      font-size: 11px;
      color: var(--muted);
      font-family: var(--mono);
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .status-pill {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-sub);
      font-family: var(--mono);
    }

    .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--safe);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .time-display {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
    }

    /* ─── NAV ────────────────────────────────────────────────────── */
    .nav-section-label {
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
      padding: 0 20px 8px;
      margin-top: 16px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 20px;
      font-size: 13px;
      color: var(--text-sub);
      cursor: pointer;
      transition: var(--transition);
      border-left: 2px solid transparent;
      position: relative;
    }

    .nav-item:hover {
      color: var(--text);
      background: rgba(255,255,255,0.03);
    }

    .nav-item.active {
      color: var(--accent);
      border-left-color: var(--accent);
      background: rgba(201, 183, 122, 0.06);
    }

    .nav-badge {
      margin-left: auto;
      background: var(--alert);
      color: white;
      font-size: 10px;
      font-weight: 700;
      padding: 1px 6px;
      border-radius: 10px;
      font-family: var(--mono);
    }

    /* ─── VIEWS ──────────────────────────────────────────────────── */
    .view { display: none; }
    .view.active { display: block; }

    /* ─── PAGE HEADER ────────────────────────────────────────────── */
    .page-header {
      margin-bottom: 28px;
    }

    .page-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }

    .page-subtitle {
      font-size: 13px;
      color: var(--text-sub);
    }

    /* ─── GRID ───────────────────────────────────────────────────── */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px; }
    .grid-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px; }

    /* ─── CARD ───────────────────────────────────────────────────── */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
    }

    .card-label {
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .card-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--text);
      font-family: var(--mono);
      line-height: 1;
      margin-bottom: 4px;
    }

    .card-sub {
      font-size: 12px;
      color: var(--text-sub);
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 16px;
    }

    /* ─── STAT CARDS ─────────────────────────────────────────────── */
    .stat-alert .card-value { color: var(--alert); }
    .stat-safe  .card-value { color: var(--safe); }
    .stat-gold  .card-value { color: var(--accent); }

    /* ─── AGENT STATUS ───────────────────────────────────────────── */
    .agent-list { display: flex; flex-direction: column; gap: 10px; }

    .agent-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      background: var(--dark);
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }

    .agent-name {
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
    }

    .agent-role {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 2px;
    }

    .agent-status-badge {
      font-size: 10px;
      font-family: var(--mono);
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 4px;
      letter-spacing: 0.06em;
    }

    .badge-active   { background: rgba(91,140,90,0.15); color: var(--safe); border: 1px solid rgba(91,140,90,0.3); }
    .badge-pending  { background: rgba(201,183,122,0.1); color: var(--accent); border: 1px solid rgba(201,183,122,0.25); }
    .badge-offline  { background: rgba(102,102,102,0.1); color: var(--muted); border: 1px solid var(--dim); }
    .badge-alert    { background: rgba(194,91,78,0.12); color: var(--alert); border: 1px solid rgba(194,91,78,0.3); }

    /* ─── APPROVAL QUEUE ─────────────────────────────────────────── */
    .approval-list { display: flex; flex-direction: column; gap: 12px; }

    .approval-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px 20px;
      border-left: 3px solid var(--border);
      transition: var(--transition);
    }

    .approval-card.high    { border-left-color: var(--alert); }
    .approval-card.medium  { border-left-color: var(--accent); }
    .approval-card.low     { border-left-color: var(--info); }

    .approval-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .approval-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }

    .approval-meta {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 2px;
    }

    .approval-body {
      font-size: 13px;
      color: var(--text-sub);
      margin-bottom: 14px;
      line-height: 1.5;
    }

    .approval-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    /* ─── BUTTONS ────────────────────────────────────────────────── */
    .btn {
      padding: 7px 16px;
      border-radius: var(--radius);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid transparent;
      transition: var(--transition);
      font-family: var(--font);
    }

    .btn-approve {
      background: rgba(91,140,90,0.15);
      color: var(--safe);
      border-color: rgba(91,140,90,0.3);
    }
    .btn-approve:hover { background: rgba(91,140,90,0.25); }

    .btn-reject {
      background: rgba(194,91,78,0.08);
      color: var(--alert);
      border-color: rgba(194,91,78,0.25);
    }
    .btn-reject:hover { background: rgba(194,91,78,0.15); }

    .btn-view {
      background: transparent;
      color: var(--text-sub);
      border-color: var(--border);
    }
    .btn-view:hover { color: var(--text); border-color: var(--dim); }

    .inline-form {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 10px;
    }

    .inline-form input,
    .inline-form select {
      width: 100%;
      background: var(--dark);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      padding: 7px 8px;
      font-size: 12px;
      font-family: var(--font);
    }

    .funnel-row {
      display: grid;
      grid-template-columns: 180px 1fr 70px;
      gap: 10px;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }

    .funnel-label {
      font-size: 11px;
      color: var(--text-sub);
      font-family: var(--mono);
    }

    .funnel-bar-wrap {
      height: 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      overflow: hidden;
    }

    .funnel-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #d9c26b);
    }

    .funnel-rate {
      font-size: 11px;
      color: var(--text);
      font-family: var(--mono);
      text-align: right;
    }

    .priority-tag {
      font-size: 10px;
      font-weight: 700;
      font-family: var(--mono);
      padding: 2px 7px;
      border-radius: 3px;
      letter-spacing: 0.08em;
    }

    .p-high   { background: rgba(194,91,78,0.12); color: var(--alert); }
    .p-medium { background: rgba(201,183,122,0.1); color: var(--accent); }
    .p-low    { background: rgba(74,122,155,0.12); color: var(--info); }

    /* ─── BRIEFING ───────────────────────────────────────────────── */
    .briefing-content {
      font-size: 13px;
      color: var(--text-sub);
      line-height: 1.8;
    }

    .briefing-markdown {
      white-space: pre-wrap;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.7;
      color: var(--text-sub);
      background: var(--dark);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      max-height: 620px;
      overflow-y: auto;
    }

    .briefing-section { margin-bottom: 24px; }

    .briefing-section-title {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border);
    }

    .briefing-item {
      padding: 8px 0;
      border-bottom: 1px solid rgba(36,36,36,0.6);
      color: var(--text);
    }

    .briefing-source {
      font-size: 11px;
      color: var(--muted);
      font-family: var(--mono);
    }

    /* ─── CANON VIEWER ───────────────────────────────────────────── */
    .canon-viewer {
      background: var(--dark);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
    }

    .canon-locked {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 16px;
      padding: 8px 12px;
      background: rgba(201,183,122,0.05);
      border: 1px solid rgba(201,183,122,0.15);
      border-radius: 4px;
    }

    .canon-content {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text-sub);
      white-space: pre-wrap;
      line-height: 1.7;
      max-height: 600px;
      overflow-y: auto;
    }

    /* ─── LOG VIEWER ─────────────────────────────────────────────── */
    .log-stream {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-sub);
      background: var(--dark);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      max-height: 500px;
      overflow-y: auto;
      line-height: 1.8;
    }

    .log-entry { border-bottom: 1px solid rgba(36,36,36,0.4); padding: 4px 0; }
    .log-time  { color: var(--muted); }
    .log-agent { color: var(--accent); }
    .log-msg   { color: var(--text-sub); }

    /* ─── HORIZON ────────────────────────────────────────────────── */
    .elevation-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px 20px;
      margin-bottom: 12px;
    }

    .elevation-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
    }

    .elevation-body {
      font-size: 12px;
      color: var(--text-sub);
      line-height: 1.6;
    }

    .elevation-scope {
      display: inline-block;
      margin-top: 10px;
      font-size: 10px;
      font-family: var(--mono);
      font-weight: 600;
      letter-spacing: 0.08em;
      padding: 2px 8px;
      border-radius: 3px;
      background: rgba(74,122,155,0.12);
      color: var(--info);
      border: 1px solid rgba(74,122,155,0.25);
    }

    /* ─── EMPTY STATE ────────────────────────────────────────────── */
    .empty {
      text-align: center;
      padding: 48px 24px;
      color: var(--muted);
      font-size: 13px;
    }

    .empty-icon { font-size: 32px; margin-bottom: 12px; opacity: 0.4; }

    /* ─── DIVIDER ────────────────────────────────────────────────── */
    .divider {
      height: 1px;
      background: var(--border);
      margin: 24px 0;
    }

    /* ─── SCROLLBAR ──────────────────────────────────────────────── */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--dim); border-radius: 2px; }
  </style>
</head>
<body>

<div class="shell">

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="brand">
      <div class="brand-mark">
        <svg viewBox="0 0 12 12" fill="none">
          <rect x="1" y="1" width="4" height="4" stroke="#C9B77A" stroke-width="1.2"/>
          <rect x="7" y="1" width="4" height="4" stroke="#C9B77A" stroke-width="1.2" opacity="0.5"/>
          <rect x="1" y="7" width="4" height="4" stroke="#C9B77A" stroke-width="1.2" opacity="0.5"/>
          <rect x="7" y="7" width="4" height="4" stroke="#C9B77A" stroke-width="1.2" opacity="0.3"/>
        </svg>
      </div>
      <div>
        <div class="brand-name">Permanence OS</div>
      </div>
      <div class="brand-version">v0.4</div>
    </div>
    <div class="topbar-right">
      <div class="status-pill">
        <div class="dot"></div>
        <span id="system-status-text">SYSTEM ACTIVE</span>
      </div>
      <div class="time-display" id="clock">--:--:--</div>
    </div>
  </header>

  <!-- NAV -->
  <nav class="nav">
    <div class="nav-section-label">Command</div>
    <div class="nav-item active" data-view="overview" onclick="switchView('overview', this)">
      <span>⬡</span> Overview
    </div>
    <div class="nav-item" data-view="approvals" onclick="switchView('approvals', this)">
      <span>◈</span> Approvals
      <span class="nav-badge" id="approval-badge" style="display:none">0</span>
    </div>
    <div class="nav-item" data-view="briefing" onclick="switchView('briefing', this)">
      <span>◉</span> Briefing
    </div>
    <div class="nav-item" data-view="revenue" onclick="switchView('revenue', this)">
      <span>¤</span> Revenue Ops
    </div>

    <div class="nav-section-label">Intelligence</div>
    <div class="nav-item" data-view="horizon" onclick="switchView('horizon', this)">
      <span>◎</span> Horizon
    </div>
    <div class="nav-item" data-view="memory" onclick="switchView('memory', this)">
      <span>◫</span> Memory
    </div>

    <div class="nav-section-label">Governance</div>
    <div class="nav-item" data-view="canon" onclick="switchView('canon', this)">
      <span>⬟</span> Canon
    </div>
    <div class="nav-item" data-view="logs" onclick="switchView('logs', this)">
      <span>◱</span> Audit Log
    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <main class="main">

    <!-- ── OVERVIEW ── -->
    <div class="view active" id="view-overview">
      <div class="page-header">
        <div class="page-title">Overview</div>
        <div class="page-subtitle">System state at a glance</div>
      </div>

      <div class="grid-4">
        <div class="card stat-alert" id="stat-approvals">
          <div class="card-label">Pending Approvals</div>
          <div class="card-value" id="stat-approvals-val">—</div>
          <div class="card-sub">Require your decision</div>
        </div>
        <div class="card stat-safe" id="stat-tests">
          <div class="card-label">Tests Passing</div>
          <div class="card-value" id="stat-tests-val">—</div>
          <div class="card-sub">Canon fidelity confirmed</div>
        </div>
        <div class="card stat-gold">
          <div class="card-label">Canon Version</div>
          <div class="card-value" id="stat-canon-ver" style="font-size:18px">—</div>
          <div class="card-sub">Constitutional law</div>
        </div>
        <div class="card">
          <div class="card-label">Horizon Reports</div>
          <div class="card-value" id="stat-horizon-val">—</div>
          <div class="card-sub">Elevation proposals</div>
        </div>
      </div>

      <div class="grid-2">
        <div class="card">
          <div class="card-title">Agent Status</div>
          <div class="agent-list" id="agent-list">
            <div class="empty">Loading agents...</div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Architecture</div>
          <div style="font-size:12px; color: var(--text-sub); font-family: var(--mono); line-height: 2;">
            <div style="color: var(--text)">Layer 0 — Human (Payton) · Final Authority</div>
            <div>Layer 1 — Base Canon · Constitutional Law</div>
            <div>Layer 2 — Polemarch · Governor & Router</div>
            <div>Layer 3 — Executive Bots · Strategy</div>
            <div>Layer 4 — Department Bots · Specialized Work</div>
            <div>Layer 5 — Audit Loop · Evolution & Learning</div>
            <div style="margin-top:12px; color: var(--muted)">+ Horizon Agent · Landscape Observer</div>
          </div>
        </div>
      </div>

      <div class="card" id="latest-task-card">
        <div class="card-title">Latest Task Routing</div>
        <div style="font-size:13px; color: var(--text); margin-bottom: 6px;" id="latest-task-goal">Loading latest task...</div>
        <div style="font-size:11px; color: var(--text-sub); margin-bottom: 12px; font-family: var(--mono);" id="latest-task-meta">—</div>
        <div style="font-size:11px; color: var(--muted); margin-bottom: 12px; font-family: var(--mono);" id="latest-task-promotion">promotion: —</div>
        <div id="latest-task-routes" style="display: grid; gap: 6px;">
          <div style="font-size:12px; color: var(--muted);">No routing data yet.</div>
        </div>
      </div>
    </div>

    <!-- ── APPROVALS ── -->
    <div class="view" id="view-approvals">
      <div class="page-header">
        <div class="page-title">Approval Queue</div>
        <div class="page-subtitle">Human authority is final. All HIGH risk actions wait here.</div>
      </div>
      <div class="approval-list" id="approval-list">
        <div class="empty">
          <div class="empty-icon">◈</div>
          Loading approval queue...
        </div>
      </div>
    </div>

    <!-- ── BRIEFING ── -->
    <div class="view" id="view-briefing">
      <div class="page-header">
        <div class="page-title">Daily Briefing</div>
        <div class="page-subtitle">Intelligence summary — compressed, sourced, actionable</div>
      </div>
      <div class="card">
        <div class="briefing-content" id="briefing-content">
          <div class="empty">Loading briefing...</div>
        </div>
      </div>
    </div>

    <!-- ── REVENUE ── -->
    <div class="view" id="view-revenue">
      <div class="page-header">
        <div class="page-title">Revenue Ops</div>
        <div class="page-subtitle">Daily execution board, queue actions, and live pipeline metrics</div>
      </div>

      <div class="grid-4">
        <div class="card stat-gold">
          <div class="card-label">Queue Actions</div>
          <div class="card-value" id="revenue-queue-count">—</div>
          <div class="card-sub">Next 7 actions generated</div>
        </div>
        <div class="card">
          <div class="card-label">Open Leads</div>
          <div class="card-value" id="revenue-open-leads">—</div>
          <div class="card-sub">Current pipeline open count</div>
        </div>
        <div class="card">
          <div class="card-label">Weighted Pipeline</div>
          <div class="card-value" id="revenue-weighted">$—</div>
          <div class="card-sub">Probability-adjusted value</div>
        </div>
        <div class="card stat-alert">
          <div class="card-label">Urgent Due (24h)</div>
          <div class="card-value" id="revenue-urgent-count">—</div>
          <div class="card-sub">Pipeline actions due now</div>
        </div>
      </div>

      <div class="card" style="margin-bottom: 16px;">
        <div class="card-title">Conversion Funnel (This Week)</div>
        <div id="revenue-funnel-summary" style="font-size:11px; color:var(--muted); font-family:var(--mono); margin-bottom:10px;">
          Loading funnel...
        </div>
        <div id="revenue-bottleneck" style="font-size:12px; color:var(--text-sub); margin-bottom:10px;">
          Detecting bottleneck...
        </div>
        <div id="revenue-funnel-rows"><div class="empty">Loading funnel stages...</div></div>
      </div>

      <div class="card" style="margin-bottom: 16px;">
        <div class="card-title">Quick Add Lead</div>
        <form id="revenueLeadForm" onsubmit="createRevenueLead(event)">
          <div class="inline-form">
            <input name="name" placeholder="Lead name" required>
            <input name="source" placeholder="Source (e.g. X DM)" value="dashboard">
            <select name="stage">
              <option value="lead" selected>lead</option>
              <option value="qualified">qualified</option>
              <option value="call_scheduled">call_scheduled</option>
              <option value="proposal_sent">proposal_sent</option>
              <option value="negotiation">negotiation</option>
            </select>
            <input name="est_value" type="number" step="1" min="0" value="1500" placeholder="Estimated value">
          </div>
          <div class="inline-form">
            <input name="next_action" placeholder="Next action" value="Send intake + book fit call">
            <input name="next_action_due" type="date">
            <input name="offer" placeholder="Offer" value="Permanence OS Foundation Setup">
            <input name="notes" placeholder="Notes (optional)">
          </div>
          <div class="approval-actions">
            <button class="btn btn-approve" type="submit">Add Lead</button>
            <span id="revenueLeadStatus" style="font-size:11px; color:var(--muted); font-family:var(--mono);"></span>
          </div>
        </form>
      </div>

      <div class="grid-2">
        <div class="card">
          <div class="card-title">Today's Non-Negotiables</div>
          <div id="revenue-non-negotiables"><div class="empty">Loading board...</div></div>
        </div>
        <div class="card">
          <div class="card-title">Queue Actions</div>
          <div id="revenue-queue-actions"><div class="empty">Loading queue...</div></div>
        </div>
      </div>

      <div class="card" style="margin-bottom: 16px;">
        <div class="card-title">Urgent Pipeline Actions</div>
        <div id="revenue-urgent-actions"><div class="empty">Loading urgent actions...</div></div>
      </div>

      <div class="grid-2">
        <div class="card">
          <div class="card-title">Open Pipeline (Top 10)</div>
          <div id="revenue-open-rows"><div class="empty">Loading open pipeline...</div></div>
        </div>
        <div class="card">
          <div class="card-title">Latest Intake Submissions</div>
          <div id="revenue-intake-rows"><div class="empty">Loading intake submissions...</div></div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Data Sources</div>
        <div id="revenue-sources"><div class="empty">Loading source paths...</div></div>
      </div>
    </div>

    <!-- ── HORIZON ── -->
    <div class="view" id="view-horizon">
      <div class="page-header">
        <div class="page-title">Horizon Agent</div>
        <div class="page-subtitle">Landscape observation. Elevation proposals. You decide what becomes law.</div>
      </div>
      <div id="horizon-content">
        <div class="empty">
          <div class="empty-icon">◎</div>
          Loading horizon reports...
        </div>
      </div>
    </div>

    <!-- ── MEMORY ── -->
    <div class="view" id="view-memory">
      <div class="page-header">
        <div class="page-title">Episodic Memory</div>
        <div class="page-subtitle">What happened. What worked. What failed. Append-only.</div>
      </div>
      <div class="card">
        <div id="memory-list">
          <div class="empty">Loading memory entries...</div>
        </div>
      </div>
    </div>

    <!-- ── CANON ── -->
    <div class="view" id="view-canon">
      <div class="page-header">
        <div class="page-title">The Canon</div>
        <div class="page-subtitle">Constitutional law. Read-only here. Modify only through ceremony.</div>
      </div>
      <div class="canon-viewer">
        <div class="canon-locked">
          <span>⬟</span>
          LOCKED — This interface is read-only. Canon amendments require human ceremony and direct file edit.
        </div>
        <div class="canon-content" id="canon-content">Loading Canon...</div>
      </div>
    </div>

    <!-- ── LOGS ── -->
    <div class="view" id="view-logs">
      <div class="page-header">
        <div class="page-title">Audit Log</div>
        <div class="page-subtitle">Append-only. Every decision recorded. Nothing hidden.</div>
      </div>
      <div class="log-stream" id="log-stream">Loading logs...</div>
    </div>

  </main>
</div>

<script>
// ─────────────────────────────────────────────
// CONFIG
// ─────────────────────────────────────────────
const API_BASE = window.location.protocol.startsWith("http")
  ? `${window.location.origin}/api`
  : "http://127.0.0.1:8000/api";
let refreshInterval = null;

// ─────────────────────────────────────────────
// NAVIGATION
// ─────────────────────────────────────────────
function switchView(viewId, el) {
  document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
  document.querySelectorAll(".nav-item").forEach(n => n.classList.remove("active"));
  document.getElementById(`view-${viewId}`).classList.add("active");
  if (el) el.classList.add("active");
  loadView(viewId);
}

function loadView(viewId) {
  switch(viewId) {
    case "overview":  loadOverview(); break;
    case "approvals": loadApprovals(); break;
    case "briefing":  loadBriefing(); break;
    case "revenue":   loadRevenue(); break;
    case "horizon":   loadHorizon(); break;
    case "memory":    loadMemory(); break;
    case "canon":     loadCanon(); break;
    case "logs":      loadLogs(); break;
  }
}

// ─────────────────────────────────────────────
// CLOCK
// ─────────────────────────────────────────────
function updateClock() {
  const now = new Date();
  document.getElementById("clock").textContent =
    now.toLocaleTimeString("en-US", { hour12: false });
}
setInterval(updateClock, 1000);
updateClock();

// ─────────────────────────────────────────────
// API
// ─────────────────────────────────────────────
async function apiFetch(endpoint) {
  try {
    const res = await fetch(`${API_BASE}${endpoint}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  } catch(e) {
    return null;
  }
}

async function apiPost(endpoint, body) {
  try {
    const res = await fetch(`${API_BASE}${endpoint}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });
    return await res.json();
  } catch(e) {
    return null;
  }
}

function escapeHtml(value) {
  return String(value ?? "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");
}

function formatCurrency(value) {
  const numeric = Number(value ?? 0);
  if (!Number.isFinite(numeric)) return "$0";
  return new Intl.NumberFormat("en-US", { style: "currency", currency: "USD", maximumFractionDigits: 0 }).format(numeric);
}

function formatPercent(rate) {
  const numeric = Number(rate);
  if (!Number.isFinite(numeric)) return "n/a";
  return `${(numeric * 100).toFixed(0)}%`;
}

const REVENUE_STAGE_ORDER = ["lead", "qualified", "call_scheduled", "proposal_sent", "negotiation", "won"];

function nextRevenueStage(currentStage) {
  const normalized = String(currentStage || "lead").toLowerCase();
  const index = REVENUE_STAGE_ORDER.indexOf(normalized);
  if (index < 0 || index >= REVENUE_STAGE_ORDER.length - 1) return null;
  return REVENUE_STAGE_ORDER[index + 1];
}

async function createRevenueLead(event) {
  event.preventDefault();
  const form = event.target;
  const statusEl = document.getElementById("revenueLeadStatus");
  const data = new FormData(form);
  const payload = {
    name: String(data.get("name") || "").trim(),
    source: String(data.get("source") || "dashboard").trim(),
    stage: String(data.get("stage") || "lead"),
    offer: String(data.get("offer") || "Permanence OS Foundation Setup").trim(),
    est_value: Number(data.get("est_value") || 1500),
    next_action: String(data.get("next_action") || "").trim(),
    next_action_due: String(data.get("next_action_due") || "").trim(),
    notes: String(data.get("notes") || "").trim(),
  };
  if (!payload.name) {
    statusEl.textContent = "Name is required.";
    statusEl.style.color = "var(--alert)";
    return;
  }
  statusEl.textContent = "Adding lead...";
  statusEl.style.color = "var(--muted)";
  const result = await apiPost("/revenue/pipeline/lead", payload);
  if (!result || String(result.status || "").toUpperCase() !== "CREATED") {
    statusEl.textContent = "Failed to add lead.";
    statusEl.style.color = "var(--alert)";
    return;
  }
  statusEl.textContent = `Lead added: ${result.lead_id ?? "unknown"}`;
  statusEl.style.color = "var(--safe)";
  form.reset();
  const stageField = form.querySelector("select[name='stage']");
  if (stageField) stageField.value = "lead";
  const estField = form.querySelector("input[name='est_value']");
  if (estField) estField.value = "1500";
  const offerField = form.querySelector("input[name='offer']");
  if (offerField) offerField.value = "Permanence OS Foundation Setup";
  const sourceField = form.querySelector("input[name='source']");
  if (sourceField) sourceField.value = "dashboard";
  const nextActionField = form.querySelector("input[name='next_action']");
  if (nextActionField) nextActionField.value = "Send intake + book fit call";
  await loadRevenue();
}

async function setRevenueLeadStage(leadId, stage) {
  const payload = { stage: String(stage || "").toLowerCase() };
  if (payload.stage !== "won" && payload.stage !== "lost") {
    const nextAction = prompt("Next action (optional):", "Follow up on pipeline action");
    if (nextAction !== null) payload.next_action = nextAction;
    const defaultDue = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
    const due = prompt("Next action due (YYYY-MM-DD, optional):", defaultDue);
    if (due !== null) payload.next_action_due = due.trim();
  } else if (payload.stage === "won") {
    const valueText = prompt("Actual value for won deal (optional):", "");
    if (valueText !== null && valueText.trim() !== "" && !Number.isNaN(Number(valueText))) {
      payload.actual_value = Number(valueText);
    }
  }
  const result = await apiPost(`/revenue/pipeline/${leadId}`, payload);
  if (!result || String(result.status || "").toUpperCase() !== "UPDATED") {
    alert("Could not update lead stage.");
    return;
  }
  await loadRevenue();
}

async function advanceRevenueLead(leadId, currentStage) {
  const next = nextRevenueStage(currentStage);
  if (!next) {
    alert("No next stage available for this lead.");
    return;
  }
  await setRevenueLeadStage(leadId, next);
}

// ─────────────────────────────────────────────
// OVERVIEW
// ─────────────────────────────────────────────
async function loadOverview() {
  const data = await apiFetch("/status");
  if (!data) {
    document.getElementById("system-status-text").textContent = "API OFFLINE";
    return;
  }

  // Stats
  const pending = data.queue?.pending_approvals ?? 0;
  document.getElementById("stat-approvals-val").textContent = pending;
  document.getElementById("stat-tests-val").textContent =
    data.tests?.passing !== undefined ? `${data.tests.passing}` : "—";
  document.getElementById("stat-canon-ver").textContent =
    data.canon?.version ?? "—";
  document.getElementById("stat-horizon-val").textContent =
    data.horizon?.reports_generated ?? 0;

  // Badge
  const badge = document.getElementById("approval-badge");
  if (pending > 0) {
    badge.textContent = pending;
    badge.style.display = "block";
  } else {
    badge.style.display = "none";
  }

  // Agents
  const agents = data.agents ?? {};
  const agentDefs = [
    { key: "polemarch",  label: "Polemarch",  role: "Governor & Router" },
    { key: "researcher", label: "Researcher", role: "Data Gatherer" },
    { key: "planner",    label: "Planner",    role: "Task Specification" },
    { key: "executor",   label: "Executor",   role: "Output Producer" },
    { key: "reviewer",   label: "Reviewer",   role: "Quality Evaluator" },
    { key: "horizon",    label: "Horizon",    role: "Landscape Observer" },
  ];

  document.getElementById("agent-list").innerHTML = agentDefs.map(a => {
    const info = agents[a.key] ?? {};
    const status = info.status ?? "NOT_YET_RUN";
    const badgeClass = {
      "ACTIVE": "badge-active",
      "NOT_YET_RUN": "badge-offline",
      "ERROR": "badge-alert",
    }[status] ?? "badge-offline";
    const lastActive = info.last_active
      ? new Date(info.last_active).toLocaleString()
      : "Never";

    return `
      <div class="agent-row">
        <div>
          <div class="agent-name">${a.label}</div>
          <div class="agent-role">${a.role} · ${lastActive}</div>
        </div>
        <span class="agent-status-badge ${badgeClass}">${status}</span>
      </div>`;
  }).join("");

  // Latest task + model routes
  const latest = data.latest_task ?? null;
  const promotion = data.promotion ?? {};
  const goalEl = document.getElementById("latest-task-goal");
  const metaEl = document.getElementById("latest-task-meta");
  const promotionEl = document.getElementById("latest-task-promotion");
  const routesEl = document.getElementById("latest-task-routes");

  const promotionParts = [
    promotion.queue_items !== undefined ? `queue=${promotion.queue_items}` : null,
    promotion.glance_gate ? `glance=${promotion.glance_gate}` : null,
    promotion.phase_gate ? `phase=${promotion.phase_gate}` : null,
  ].filter(Boolean);
  const promotionText = promotionParts.join(" | ") || "promotion: —";
  let reviewText = "";
  if (promotion.review_last_generated) {
    const reviewDate = new Date(promotion.review_last_generated);
    if (!Number.isNaN(reviewDate.getTime())) {
      reviewText = ` | review=${reviewDate.toLocaleString()}`;
    }
  }
  promotionEl.textContent = promotionText + reviewText;

  if (!latest) {
    goalEl.textContent = "No episodic task found yet.";
    metaEl.textContent = "—";
    routesEl.innerHTML = `<div style="font-size:12px; color: var(--muted);">No routing data yet.</div>`;
    return;
  }

  goalEl.textContent = latest.goal ?? "Unknown task goal";
  const parts = [
    latest.task_id ? `task=${latest.task_id}` : null,
    latest.stage ? `stage=${latest.stage}` : null,
    latest.status ? `status=${latest.status}` : null,
    latest.risk_tier ? `risk=${latest.risk_tier}` : null,
  ].filter(Boolean);
  metaEl.textContent = parts.join(" | ") || "—";

  const routes = latest.model_routes ?? {};
  const routeKeys = Object.keys(routes);
  if (routeKeys.length === 0) {
    routesEl.innerHTML = `<div style="font-size:12px; color: var(--muted);">No model routes recorded for this task.</div>`;
    return;
  }
  routesEl.innerHTML = routeKeys.map(k => `
    <div style="display:flex; justify-content:space-between; gap:12px; padding:7px 10px; background:var(--dark); border:1px solid var(--border); border-radius:4px;">
      <span style="font-size:11px; color:var(--text-sub); text-transform:uppercase; letter-spacing:0.06em;">${escapeHtml(k)}</span>
      <span style="font-size:11px; color:var(--accent); font-family:var(--mono);">${escapeHtml(routes[k])}</span>
    </div>
  `).join("");
}

// ─────────────────────────────────────────────
// APPROVALS
// ─────────────────────────────────────────────
async function loadApprovals() {
  const data = await apiFetch("/approvals");
  const list = document.getElementById("approval-list");

  if (!data || data.total_pending === 0) {
    list.innerHTML = `
      <div class="empty">
        <div class="empty-icon">◈</div>
        No pending approvals. System is in balance.
      </div>`;
    return;
  }

  list.innerHTML = data.approvals.map(a => {
    const priority = (a.priority ?? "MEDIUM").toLowerCase();
    const pClass = { high: "p-high", medium: "p-medium", low: "p-low" }[priority] ?? "p-medium";
    const id = a.proposal_id ?? a.id ?? a.approval_id ?? "unknown";

    return `
      <div class="approval-card ${priority}" id="approval-${id}">
        <div class="approval-header">
          <div>
            <div class="approval-title">${a.title ?? "Pending Action"}</div>
            <div class="approval-meta">
              ${a.implementation_scope ?? "review"} · Created ${a.created_at ? new Date(a.created_at).toLocaleDateString() : "—"}
            </div>
          </div>
          <span class="priority-tag ${pClass}">${(a.priority ?? "MEDIUM").toUpperCase()}</span>
        </div>
        <div class="approval-body">
          ${a.finding_summary ?? a.proposed_change ?? "See full report for details."}
        </div>
        ${a.draft_codex_task ? `<div class="approval-body" style="font-size:11px; color: var(--muted); margin-bottom: 10px;">
          Codex task: ${a.draft_codex_task}
        </div>` : ""}
        <div class="approval-actions">
          <button class="btn btn-approve" onclick="approveItem('${id}')">Approve</button>
          <button class="btn btn-reject" onclick="rejectItem('${id}')">Reject</button>
        </div>
      </div>`;
  }).join("");
}

async function approveItem(id) {
  const notes = prompt("Add notes (optional):", "") ?? "";
  const result = await apiPost(`/approvals/${id}/approve`, { notes });
  if (result) {
    const el = document.getElementById(`approval-${id}`);
    if (el) {
      el.style.opacity = "0.4";
      el.style.pointerEvents = "none";
      el.querySelector(".approval-actions").innerHTML =
        `<span style="color: var(--safe); font-size: 12px; font-family: var(--mono);">✓ APPROVED · ${new Date().toLocaleTimeString()}</span>`;
    }
  }
}

async function rejectItem(id) {
  const reason = prompt("Rejection reason (required):");
  if (!reason) return;
  const result = await apiPost(`/approvals/${id}/reject`, { reason });
  if (result) {
    const el = document.getElementById(`approval-${id}`);
    if (el) {
      el.style.opacity = "0.4";
      el.style.pointerEvents = "none";
      el.querySelector(".approval-actions").innerHTML =
        `<span style="color: var(--alert); font-size: 12px; font-family: var(--mono);">✗ REJECTED · ${new Date().toLocaleTimeString()}</span>`;
    }
  }
}

// ─────────────────────────────────────────────
// BRIEFING
// ─────────────────────────────────────────────
async function loadBriefing() {
  const data = await apiFetch("/briefings/latest");
  const el = document.getElementById("briefing-content");

  if (!data) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">◉</div>No briefing found. Run the Briefing Agent to generate one.</div>`;
    return;
  }

  if (data.format === "markdown" && data.content_markdown) {
    el.innerHTML = `
      <div style="font-size:11px; color: var(--muted); margin-bottom: 10px; font-family: var(--mono);">
        ${escapeHtml(data.filename ?? "briefing.md")} · ${escapeHtml(data.generated_at ?? "")}
      </div>
      <div class="briefing-markdown">${escapeHtml(data.content_markdown)}</div>
    `;
    return;
  }

  // Render briefing data — adapt to your actual briefing JSON structure
  const sections = data.sections ?? data.categories ?? { "Briefing": [data] };
  el.innerHTML = Object.entries(sections).map(([title, items]) => `
    <div class="briefing-section">
      <div class="briefing-section-title">${title}</div>
      ${Array.isArray(items) ? items.map(item => `
        <div class="briefing-item">
          ${item.summary ?? item.content ?? JSON.stringify(item).slice(0, 200)}
          ${item.source ? `<div class="briefing-source">${item.source}</div>` : ""}
        </div>`).join("") : `<div class="briefing-item">${JSON.stringify(items)}</div>`}
    </div>`).join("");
}

// ─────────────────────────────────────────────
// REVENUE OPS
// ─────────────────────────────────────────────
async function loadRevenue() {
  const data = await apiFetch("/revenue/latest");

  if (!data) {
    document.getElementById("revenue-queue-count").textContent = "—";
    document.getElementById("revenue-open-leads").textContent = "—";
    document.getElementById("revenue-weighted").textContent = "$—";
    document.getElementById("revenue-urgent-count").textContent = "—";
    document.getElementById("revenue-funnel-summary").textContent = "No funnel data available yet.";
    document.getElementById("revenue-bottleneck").textContent = "Bottleneck unavailable.";
    document.getElementById("revenue-funnel-rows").innerHTML = `<div class="empty">No funnel stages available.</div>`;
    document.getElementById("revenue-non-negotiables").innerHTML = `<div class="empty">No revenue data available yet.</div>`;
    document.getElementById("revenue-queue-actions").innerHTML = `<div class="empty">No queue data available yet.</div>`;
    document.getElementById("revenue-urgent-actions").innerHTML = `<div class="empty">No urgent actions available yet.</div>`;
    document.getElementById("revenue-open-rows").innerHTML = `<div class="empty">No open leads found yet.</div>`;
    document.getElementById("revenue-intake-rows").innerHTML = `<div class="empty">No intake submissions found yet.</div>`;
    document.getElementById("revenue-sources").innerHTML = `<div class="empty">Run money loop to generate data sources.</div>`;
    return;
  }

  const queue = data.queue ?? {};
  const board = data.board ?? {};
  const pipeline = data.pipeline ?? {};
  const intake = data.intake ?? {};
  const funnel = data.funnel ?? {};
  const sources = data.sources ?? {};

  document.getElementById("revenue-queue-count").textContent = queue.count ?? 0;
  document.getElementById("revenue-open-leads").textContent = pipeline.open_count ?? 0;
  document.getElementById("revenue-weighted").textContent = formatCurrency(pipeline.weighted_value ?? 0);
  document.getElementById("revenue-urgent-count").textContent = pipeline.urgent_count ?? 0;

  const funnelWeek = (funnel.week_start && funnel.week_end) ? `${funnel.week_start} to ${funnel.week_end}` : "week unknown";
  document.getElementById("revenue-funnel-summary").textContent =
    `week=${funnelWeek} | intake=${funnel.intake_week ?? 0} | leads=${funnel.leads_created_week ?? 0} | wins=${funnel.wins_week ?? 0}`;

  const bottleneck = funnel.bottleneck ?? null;
  if (bottleneck && Number.isFinite(Number(bottleneck.rate))) {
    document.getElementById("revenue-bottleneck").innerHTML =
      `<strong style="color:var(--alert);">Bottleneck:</strong> ${escapeHtml(bottleneck.label ?? bottleneck.key ?? "unknown")} (${escapeHtml(formatPercent(bottleneck.rate))}, ${escapeHtml(String(bottleneck.numerator ?? 0))}/${escapeHtml(String(bottleneck.denominator ?? 0))})<br>` +
      `<span style="color:var(--muted);">${escapeHtml(bottleneck.recommendation ?? "No recommendation")}</span>`;
  } else {
    document.getElementById("revenue-bottleneck").textContent = "Bottleneck: insufficient data.";
  }

  const segments = Array.isArray(funnel.segments) ? funnel.segments : [];
  document.getElementById("revenue-funnel-rows").innerHTML = segments.length
    ? segments.map((segment) => {
      const rate = Number(segment.rate);
      const width = Number.isFinite(rate) ? Math.max(0, Math.min(100, rate * 100)) : 0;
      const suffix = `(${segment.numerator ?? 0}/${segment.denominator ?? 0})`;
      return `
        <div class="funnel-row">
          <div class="funnel-label">${escapeHtml(segment.label ?? segment.key ?? "unknown")} ${escapeHtml(suffix)}</div>
          <div class="funnel-bar-wrap"><div class="funnel-bar" style="width:${width}%"></div></div>
          <div class="funnel-rate">${escapeHtml(formatPercent(segment.rate))}</div>
        </div>
      `;
    }).join("")
    : `<div class="empty">No funnel stages available.</div>`;

  const nonNegotiables = Array.isArray(board.non_negotiables) ? board.non_negotiables : [];
  document.getElementById("revenue-non-negotiables").innerHTML = nonNegotiables.length
    ? nonNegotiables.map((item, index) => `
      <div style="padding:8px 0; border-bottom:1px solid var(--border); font-size:12px; color:var(--text-sub);">
        <span style="color:var(--accent); font-family:var(--mono); margin-right:8px;">${index + 1}.</span>${escapeHtml(item)}
      </div>`).join("")
    : `<div class="empty">No non-negotiables found. Generate an execution board.</div>`;

  const queueActions = Array.isArray(queue.actions) ? queue.actions : [];
  document.getElementById("revenue-queue-actions").innerHTML = queueActions.length
    ? queueActions.map(action => `
      <div style="padding:8px 0; border-bottom:1px solid var(--border); font-size:12px; color:var(--text-sub);">
        ${escapeHtml(action)}
      </div>`).join("")
    : `<div class="empty">No queue actions found. Run revenue action queue.</div>`;

  const urgent = Array.isArray(board.urgent_actions) ? board.urgent_actions : [];
  document.getElementById("revenue-urgent-actions").innerHTML = urgent.length
    ? urgent.map(item => `
      <div style="padding:8px 0; border-bottom:1px solid var(--border); font-size:12px; color:var(--text-sub);">
        ${escapeHtml(item)}
      </div>`).join("")
    : `<div class="empty">No urgent pipeline actions due.</div>`;

  const openRows = Array.isArray(pipeline.open_rows) ? pipeline.open_rows : [];
  document.getElementById("revenue-open-rows").innerHTML = openRows.length
    ? openRows.map(row => `
      <div style="padding:8px 0; border-bottom:1px solid var(--border); font-size:11px; color:var(--text-sub);">
        <div style="font-family:var(--mono); margin-bottom:6px;">
          ${escapeHtml(row.lead_id ?? "unknown")} | ${escapeHtml(row.name ?? "unknown")} | stage=${escapeHtml(row.stage ?? "lead")} | est=${escapeHtml(formatCurrency(row.est_value ?? 0))} | due=${escapeHtml(row.next_action_due ?? "-")}
        </div>
        <div class="approval-actions">
          <button class="btn btn-view" onclick="advanceRevenueLead('${String(row.lead_id || "").replace(/'/g, "\\'")}', '${String(row.stage || "lead").replace(/'/g, "\\'")}')">Advance</button>
          <button class="btn btn-approve" onclick="setRevenueLeadStage('${String(row.lead_id || "").replace(/'/g, "\\'")}', 'won')">Won</button>
          <button class="btn btn-reject" onclick="setRevenueLeadStage('${String(row.lead_id || "").replace(/'/g, "\\'")}', 'lost')">Lost</button>
        </div>
      </div>`).join("")
    : `<div class="empty">No open leads found yet.</div>`;

  const intakeRows = Array.isArray(intake.rows) ? intake.rows : [];
  document.getElementById("revenue-intake-rows").innerHTML = intakeRows.length
    ? intakeRows.map(row => `
      <div style="padding:8px 0; border-bottom:1px solid var(--border); font-size:11px; color:var(--text-sub);">
        <div style="font-family:var(--mono); color:var(--text);">${escapeHtml(row.name ?? "unknown")} · ${escapeHtml(row.email ?? "unknown")}</div>
        <div>workflow=${escapeHtml(row.workflow ?? "-")} | package=${escapeHtml(row.package ?? "-")}</div>
      </div>`).join("")
    : `<div class="empty">No intake submissions found yet.</div>`;

  const inbox = board.inbox_pressure ?? {};
  const sourceRows = [
    `Queue source: ${sources.queue ?? "none"}`,
    `Architecture source: ${sources.architecture ?? "none"}`,
    `Execution board source: ${sources.execution_board ?? "none"}`,
    `Pipeline source: ${sources.pipeline ?? "none"}`,
    `Intake source: ${intake.path ?? "none"}`,
    `Inbox pressure: P0=${inbox.P0 ?? 0} | P1=${inbox.P1 ?? 0} | P2=${inbox.P2 ?? 0} | P3=${inbox.P3 ?? 0}`,
  ];
  document.getElementById("revenue-sources").innerHTML = sourceRows
    .map(row => `<div style="padding:8px 0; border-bottom:1px solid var(--border); font-size:11px; color:var(--muted); font-family:var(--mono);">${escapeHtml(row)}</div>`)
    .join("");
}

// ─────────────────────────────────────────────
// HORIZON
// ─────────────────────────────────────────────
async function loadHorizon() {
  const data = await apiFetch("/horizon/latest");
  const el = document.getElementById("horizon-content");

  if (!data) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">◎</div>No horizon report found. Run <span style="font-family:var(--mono)">python horizon_agent.py</span> to generate one.</div>`;
    return;
  }

  const proposals = data.proposals ?? [];
  const aheads = data.ahead_confirmations ?? [];

  el.innerHTML = `
    <div class="grid-3" style="margin-bottom: 20px;">
      <div class="card">
        <div class="card-label">Signals Observed</div>
        <div class="card-value">${data.signals_observed ?? 0}</div>
      </div>
      <div class="card">
        <div class="card-label">Signals Filtered</div>
        <div class="card-value" style="color: var(--muted)">${data.signals_filtered ?? 0}</div>
      </div>
      <div class="card stat-gold">
        <div class="card-label">Proposals</div>
        <div class="card-value">${proposals.length}</div>
      </div>
    </div>

    ${aheads.length ? `
    <div class="card" style="margin-bottom:16px; border-left: 3px solid var(--safe);">
      <div class="card-title" style="color: var(--safe)">Where We're Ahead</div>
      ${aheads.map(a => `<div style="font-size:12px; color: var(--text-sub); padding: 6px 0; border-bottom: 1px solid var(--border);">${a}</div>`).join("")}
    </div>` : ""}

    <div style="font-size:13px; font-weight:600; color: var(--text); margin-bottom: 12px;">Elevation Proposals</div>
    ${proposals.length === 0
      ? `<div class="empty">No proposals this cycle. System is current.</div>`
      : proposals.map(p => `
        <div class="elevation-card">
          <div class="elevation-title">${p.title}</div>
          <div class="elevation-body">${p.finding_summary}</div>
          <div class="elevation-body" style="margin-top:8px; color: var(--text);">
            <strong>Proposed:</strong> ${p.proposed_change}
          </div>
          <div class="elevation-body" style="margin-top:4px;">
            <strong>Risk if ignored:</strong> ${p.risk_if_ignored}
          </div>
          <span class="elevation-scope">${p.implementation_scope ?? "review"}</span>
        </div>`).join("")
    }`;
}

// ─────────────────────────────────────────────
// MEMORY
// ─────────────────────────────────────────────
async function loadMemory() {
  const data = await apiFetch("/memory/episodic?limit=20");
  const el = document.getElementById("memory-list");

  if (!data || data.count === 0) {
    el.innerHTML = `<div class="empty">No episodic memory entries yet.</div>`;
    return;
  }

  el.innerHTML = data.entries.map(e => `
    <div style="padding: 12px 0; border-bottom: 1px solid var(--border);">
      <div style="font-size:13px; font-weight:500; color: var(--text); margin-bottom:4px;">
        ${e.task_id ?? "Unknown Task"}
      </div>
      <div style="font-size:12px; color: var(--text-sub);">${e.action_taken ?? "—"}</div>
      <div style="font-size:11px; color: var(--muted); margin-top:4px; font-family: var(--mono)">
        ${e.timestamp ?? ""} · ${e.review_result ?? "—"}
      </div>
    </div>`).join("");
}

// ─────────────────────────────────────────────
// CANON
// ─────────────────────────────────────────────
async function loadCanon() {
  const data = await apiFetch("/canon");
  const el = document.getElementById("canon-content");

  if (!data) {
    el.textContent = "Could not load Canon. Check that the API is running.";
    return;
  }

  const files = data.files ?? {};
  if (Object.keys(files).length === 0) {
    el.textContent = "No Canon files found at " + (data.path ?? "canon/");
    return;
  }

  el.textContent = Object.entries(files).map(([name, content]) =>
    `\n${"─".repeat(60)}\n// ${name}\n${"─".repeat(60)}\n\n${content}`
  ).join("\n\n");
}

// ─────────────────────────────────────────────
// LOGS
// ─────────────────────────────────────────────
async function loadLogs() {
  const data = await apiFetch("/logs?limit=100");
  const el = document.getElementById("log-stream");

  if (!data || data.count === 0) {
    el.innerHTML = `<div class="empty">No log entries found.</div>`;
    return;
  }

  el.innerHTML = data.entries.map(line => {
    const match = line.match(/\[(.+?)\] \[(.+?)\] (.+)/);
    if (match) {
      return `<div class="log-entry">
        <span class="log-time">${match[1].slice(11,19)}</span>
        <span style="color: var(--dim)"> │ </span>
        <span class="log-agent">${match[2]}</span>
        <span style="color: var(--dim)"> │ </span>
        <span class="log-msg">${match[3]}</span>
      </div>`;
    }
    return `<div class="log-entry log-msg">${line}</div>`;
  }).join("");

  el.scrollTop = el.scrollHeight;
}

// ─────────────────────────────────────────────
// INIT
// ─────────────────────────────────────────────
loadOverview();
// Auto-refresh every 30 seconds
setInterval(() => {
  const active = document.querySelector(".nav-item.active")?.dataset?.view;
  if (active) loadView(active);
}, 30000);
</script>
</body>
</html>
